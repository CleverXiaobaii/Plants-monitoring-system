<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Plant Monitoring System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36D399',
                        warning: '#FFAB00',
                        danger: '#F87272',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>

    <!-- 数据接收模块 - 完整实现 -->
    <script>
        const DataReceiver = {
            // 轮询定时器
            pollingTimer: null,

            // 初始化数据接收
            init() {
                this.startPolling();
                console.log('Using polling as a data source');
            },

            // 开始轮询数据
            startPolling() {
                console.log('使用轮询方式获取数据');

                // 设置轮询间隔(毫秒)
                const pollingInterval = 5000;

                // 初始获取数据
                this.fetchData();

                // 设置定时获取
                this.pollingTimer = setInterval(() => {
                    this.fetchData();
                }, pollingInterval);
            },

            // 使用Fetch API获取数据
            fetchData() {
                // 修改为 Flask 服务的 URL
                const apiUrl = 'http://127.0.0.1:5000/sensor-data';

                fetch(apiUrl)
                   .then(response => {
                        if (!response.ok) {
                            throw new Error('网络响应错误');
                        }
                        return response.json();
                    })
                   .then(data => {
                        console.log('获取到轮询数据:', data);
                        this.updatePlantData(data);
                    })
                   .catch(error => {
                        console.error('获取数据失败:', error);
                    });
            },

            // 更新植物数据
            updatePlantData(data) {
                // 假设 data 格式与 plantData 相似
                console.log("==> updatePlantData 收到 data：", data);
                data.forEach(newPlant => {
                    console.log("    newPlant.sensor_id =", newPlant.sensor_id);
                    const existingPlant = plantData.plants.find(p => p.id === newPlant.sensor_id);
                    console.log("    existingPlant 对象：", existingPlant);
                    if (!existingPlant) {
                        console.warn("⚠️ 找不到 plantData.plants 中 id =", newPlant.sensor_id);
                        return;
                    }

                    // 更新当前值
                    if (newPlant.temperature) {
                        existingPlant.temperature.current = newPlant.temperature;
                        // 添加到历史记录
                        existingPlant.temperature.history.push(newPlant.temperature);
                        // 保持历史记录长度一致
                        if (existingPlant.temperature.history.length > 24) {
                            existingPlant.temperature.history.shift();
                        }
                    }

                    if (newPlant.humidity) {
                        existingPlant.humidity.current = newPlant.humidity;
                        existingPlant.humidity.history.push(newPlant.humidity);
                        if (existingPlant.humidity.history.length > 24) {
                            existingPlant.humidity.history.shift();
                        }
                    }

                    if (newPlant.soil_moisture) {
                        existingPlant.soilMoisture.current = newPlant.soil_moisture;
                        existingPlant.soilMoisture.history.push(newPlant.soil_moisture);
                        if (existingPlant.soilMoisture.history.length > 24) {
                            existingPlant.soilMoisture.history.shift();
                        }
                    }

                    // 更新警报
                    if (newPlant.alerts) {
                        existingPlant.alerts = newPlant.alerts;
                    }

                });

                // 更新UI
                updateDashboard();
                updatePlantCharts();
                updateOverallTrendCharts(); // 新增：更新整体趋势图表
            },

            // 停止数据接收
            stop() {
                // 清除轮询定时器
                if (this.pollingTimer) {
                    clearInterval(this.pollingTimer);
                    this.pollingTimer = null;
                }
            },

            // 手动刷新数据
            refreshData() {
                console.log('手动刷新数据');
                // 立即触发一次数据获取
                this.fetchData();

                // 显示刷新动画
                const refreshButton = document.querySelector('button.bg-primary');
                const icon = refreshButton.querySelector('i');
                icon.classList.add('fa-spin');

                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                }, 1000);
            }
        };
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .animate-pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .data-card {
                @apply bg-white rounded-xl p-6 card-shadow transition-all duration-300 hover:shadow-lg;
            }
            .status-badge {
                @apply px-2 inline-flex text-xs leading-5 font-semibold rounded-full;
            }
            .alert-badge {
                @apply px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full;
            }
            .normal { @apply bg-green-100 text-green-800; }
            .warning { @apply bg-yellow-100 text-yellow-800; }
            .danger { @apply bg-red-100 text-red-800; }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-leaf text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">Intelligent Plant Monitoring System</h1>
            </div>
            <div class="flex items-center space-x-4">
                <nav class="hidden md:flex space-x-8">
                    <a href="#dashboard" class="text-gray-700 hover:text-primary transition-colors duration-300 font-medium">Dashboard</a>
                    <a href="#overview" class="text-gray-700 hover:text-primary transition-colors duration-300 font-medium">Overall Trend</a>
                    <a href="#plants" class="text-gray-700 hover:text-primary transition-colors duration-300 font-medium">Plant Monitoring</a>
                    <a href="#history" class="text-gray-700 hover:text-primary transition-colors duration-300 font-medium">History</a>
                </nav>
                <button id="refresh-data-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center">
                    <i class="fa fa-refresh mr-2"></i>Refresh Data
                </button>
                <button class="md:hidden text-gray-700 hover:text-primary transition-colors duration-300">
                    <i class="fa fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">
        <!-- ============ 顶部仪表盘 ============ -->
        <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="data-card">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-500 text-sm">Average temperature</p>
                        <h3 class="text-3xl font-bold" id="avg-temp">-</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                        <i class="fa fa-thermometer-half text-primary"></i>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="temp-progress" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Ideal range: 18°C - 28°C</p>
            </div>

            <div class="data-card">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-500 text-sm">Average humidity</p>
                        <h3 class="text-3xl font-bold" id="avg-humidity">-</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                        <i class="fa fa-tint text-primary"></i>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="humidity-progress" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Ideal range: 40% - 70%</p>
            </div>

            <div class="data-card">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-500 text-sm">Average soil moisture</p>
                        <h3 class="text-3xl font-bold" id="avg-soil">-</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center">
                        <i class="fa fa-tree text-yellow-500"></i>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="soil-progress" class="bg-yellow-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Ideal range: 30% - 70%</p>
            </div>

            <div class="data-card">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-500 text-sm">Number of alarms</p>
                        <h3 class="text-3xl font-bold text-danger" id="alert-count">-</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                        <i class="fa fa-exclamation-triangle text-danger"></i>
                    </div>
                </div>
                <div class="flex space-x-1 mt-2">
                    <span class="alert-badge danger">High</span>
                    <span class="alert-badge warning">Medium</span>
                    <span class="alert-badge normal">Low</span>
                </div>
            </div>
        </div>

        <!-- ============ 整体环境历史趋势 ============ -->
        <div id="overview" class="bg-white rounded-xl p-6 card-shadow mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Overall Environmental History Trend</h2>
                <div class="flex space-x-2">
                    <select id="overall-time-range" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="1h">Last 1 hour</option>
                        <option value="6h">Last 6 hour</option>
                        <option value="12h">Last 12 hour</option>
                        <option value="24h" selected>Last 24 hour</option>
                        <option value="7d">Last 1 week</option>
                    </select>
                </div>
            </div>

            <!-- 整体趋势图表 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <h3 class="text-base font-semibold mb-4">Average Temperature & Humidity Trend</h3>
                    <div class="h-64">
                        <canvas id="overall-trend-chart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 card-shadow">
                    <h3 class="text-base font-semibold mb-4">Average Soil Moisture Trend</h3>
                    <div class="h-64">
                        <canvas id="overall-soil-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 整体统计信息 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="data-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-gray-500 text-sm">Temperature Statistics</p>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fa fa-thermometer-half text-primary"></i>
                        </div>
                    </div>
                    <div class="space-y-2 mt-4">
                        <div class="flex justify-between text-sm">
                            <span>Average:</span>
                            <span id="overall-temp-avg">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Max Value:</span>
                            <span id="overall-temp-max">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Min Value:</span>
                            <span id="overall-temp-min">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Variance:</span>
                            <span id="overall-temp-var">-</span>
                        </div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-gray-500 text-sm">Humidity Statistics</p>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fa fa-tint text-primary"></i>
                        </div>
                    </div>
                    <div class="space-y-2 mt-4">
                        <div class="flex justify-between text-sm">
                            <span>Average:</span>
                            <span id="overall-humidity-avg">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Max Value:</span>
                            <span id="overall-humidity-max">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Min Value:</span>
                            <span id="overall-humidity-min">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Variance:</span>
                            <span id="overall-humidity-var">-</span>
                        </div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-gray-500 text-sm">Soil Moisture Statistics</p>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center">
                            <i class="fa fa-tree text-yellow-500"></i>
                        </div>
                    </div>
                    <div class="space-y-2 mt-4">
                        <div class="flex justify-between text-sm">
                            <span>Average:</span>
                            <span id="overall-soil-avg">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Max Value:</span>
                            <span id="overall-soil-max">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Min Value:</span>
                            <span id="overall-soil-min">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Variance:</span>
                            <span id="overall-soil-var">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ 单株植物监控 ============ -->
        <div id="plants" class="bg-white rounded-xl p-6 card-shadow mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Plant Monitoring Details</h2>
                <div class="flex space-x-2">
                    <select id="plant-select" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        <!-- 动态生成30个植株选项 -->
                        <script>
                            for (let i = 1; i <= 30; i++) {
                                const plantId = `PL${i.toString().padStart(3, '0')}`;
                                document.write(`<option value="plant-${i}">Plant${i} (ID: ${plantId})</option>`);
                            }
                        </script>
                    </select>
                    <select id="time-range" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="1h">Last 1 hour</option>
                        <option value="6h">Last 6 hour</option>
                        <option value="12h">Last 12 hour</option>
                        <option value="24h" selected>Last 24 hour</option>
                        <option value="7d">Last 1 week</option>
                    </select>
                    <button id="customize-threshold" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm transition-colors duration-300">
                        <i class="fa fa-sliders mr-1"></i>Custom Thresholds
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="data-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-gray-500 text-sm">Current Temperature</p>
                            <div class="flex items-center">
                                <h3 class="text-3xl font-bold" id="current-plant-temp">-</h3>
                                <span id="temp-status" class="ml-2 status-badge normal">Normal</span>
                            </div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fa fa-thermometer-half text-primary"></i>
                        </div>
                    </div>
                    <div class="space-y-2 mt-4">
                        <div class="flex justify-between text-sm">
                            <span>1 hour average:</span>
                            <span id="temp-1h-avg">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Variance:</span>
                            <span id="temp-variance">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Highest value:</span>
                            <span id="temp-max">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Minimum value:</span>
                            <span id="temp-min">-</span>
                        </div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-gray-500 text-sm">Current Humidity</p>
                            <div class="flex items-center">
                                <h3 class="text-3xl font-bold" id="current-plant-humidity">-</h3>
                                <span id="humidity-status" class="ml-2 status-badge normal">Normal</span>
                            </div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fa fa-tint text-primary"></i>
                        </div>
                    </div>
                    <div class="space-y-2 mt-4">
                        <div class="flex justify-between text-sm">
                            <span>1 hour average:</span>
                            <span id="humidity-1h-avg">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Variance:</span>
                            <span id="humidity-variance">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Highest value:</span>
                            <span id="humidity-max">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Minimum value:</span>
                            <span id="humidity-min">-</span>
                        </div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-gray-500 text-sm">Current Soil Moisture</p>
                            <div class="flex items-center">
                                <h3 class="text-3xl font-bold" id="current-plant-soil">-</h3>
                                <span id="soil-status" class="ml-2 status-badge normal">Normal</span>
                            </div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center">
                            <i class="fa fa-tree text-yellow-500"></i>
                        </div>
                    </div>
                    <div class="space-y-2 mt-4">
                        <div class="flex justify-between text-sm">
                            <span>1 hour average:</span>
                            <span id="soil-1h-avg">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Variance:</span>
                            <span id="soil-variance">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Highest value:</span>
                            <span id="soil-max">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Minimum value:</span>
                            <span id="soil-min">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <h3 class="text-base font-semibold mb-4">Environmental parameter trends</h3>
                    <div class="h-64">
                        <canvas id="plant-environment-chart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 card-shadow">
                    <h3 class="text-base font-semibold mb-4">Soil moisture trends</h3>
                    <div class="h-64">
                        <canvas id="plant-soil-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ 历史数据 ============ -->
        <div id="history" class="bg-white rounded-xl p-6 card-shadow">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Historical Average Data</h2>
                <div class="flex space-x-2">
                    <select id="history-time-range" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="24h">Last 24 hours</option>
                        <option value="7d">Last 7 days</option>
                        <option value="30d">Last 1 month</option>
                    </select>
                    <button class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded transition-colors duration-300">
                        <i class="fa fa-download mr-1"></i>Export
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Temp (°C)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Humidity (%)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Soil Moisture (%)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alerts</th>
                        </tr>
                    </thead>
                    <tbody id="history-table" class="bg-white divide-y divide-gray-200">
                        <!-- JavaScript动态填充 -->
                        <tr class="animate-pulse-slow">
                            <td colspan="5" class="px-6 py-10 text-center text-gray-500">loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center space-x-2">
                        <i class="fa fa-leaf text-primary text-xl"></i>
                        <span class="font-bold">Intelligent Plant Monitoring System</span>
                    </div>
                    <p class="text-gray-400 text-sm mt-1">Intelligent monitoring, scientific planting</p>
                </div>
                <div class="flex space-x-4">
                    <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                        <i class="fa fa-github text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                        <i class="fa fa-twitter text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                        <i class="fa fa-envelope text-xl"></i>
                    </a>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-6 pt-6 text-center text-gray-400 text-sm">
                &copy; 2025 Smart Plant Monitoring System | All Rights Reserved
            </div>
        </div>
    </footer>

    <!-- 自定义阈值模态框 -->
    <div id="threshold-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Custom parameter thresholds</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fa fa-times"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Temperature threshold (°C)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500">Minimum temperature</label>
                            <input type="number" id="temp-min-threshold" value="18" class="w-full px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Maximum temperature</label>
                            <input type="number" id="temp-max-threshold" value="28" class="w-full px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Humidity threshold (%)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500">Minimum Humidity</label>
                            <input type="number" id="humidity-min-threshold" value="40" class="w-full px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Maximum Humidity</label>
                            <input type="number" id="humidity-max-threshold" value="70" class="w-full px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Soil moisture threshold (%)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500">Minimum Moisture</label>
                            <input type="number" id="soil-min-threshold" value="30" class="w-full px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Maximum Moisture</label>
                            <input type="number" id="soil-max-threshold" value="70" class="w-full px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button id="save-thresholds" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all duration-300">
                        Save settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 植物数据 - 扩展到30个植株
        const plantData = {
            plants: [],
            timeLabels: Array.from({length: 24}, (_, i) => `${i}:00`)
        };

        // 生成30个植株的数据
        for (let i = 1; i <= 30; i++) {
            const plantType = i <= 10 ? 'A' : i <= 20 ? 'B' : 'C';
            const plantName = `Plant${i}`;
            
            // 为不同植物类型设置不同的阈值
            let tempThresholds, humThresholds, soilThresholds;
            
            if (plantType === 'A') {
                tempThresholds = { min: 18, max: 28 };
                humThresholds = { min: 40, max: 70 };
                soilThresholds = { min: 30, max: 70 };
            } else if (plantType === 'B') {
                tempThresholds = { min: 20, max: 30 };
                humThresholds = { min: 50, max: 80 };
                soilThresholds = { min: 40, max: 80 };
            } else {
                tempThresholds = { min: 15, max: 25 };
                humThresholds = { min: 30, max: 60 };
                soilThresholds = { min: 20, max: 60 };
            }
            
            // 创建初始历史数据
            const createHistory = (min, max) => {
                return Array.from({length: 24}, () => Math.random() * (max - min) + min);
            };
            
            plantData.plants.push({
                id: `plant-${i}`,
                name: plantName,
                type: plantType,
                temperature: {
                    current: Math.random() * 10 + 20, // 20-30°C
                    history: createHistory(tempThresholds.min, tempThresholds.max),
                    thresholds: tempThresholds
                },
                humidity: {
                    current: Math.random() * 30 + 40, // 40-70%
                    history: createHistory(humThresholds.min, humThresholds.max),
                    thresholds: humThresholds
                },
                soilMoisture: {
                    current: Math.random() * 40 + 30, // 30-70%
                    history: createHistory(soilThresholds.min, soilThresholds.max),
                    thresholds: soilThresholds
                },
                alerts: i % 5 === 0 ? [
                    { time: `2025-06-03 ${Math.floor(Math.random()*24)}:${Math.floor(Math.random()*60)}`, 
                      level: 'warning', 
                      message: '参数异常' }
                ] : []
            });
        }

        // 初始化环境参数图表
        let plantEnvironmentChart;
        let plantSoilChart;
        let overallTrendChart;
        let overallSoilChart;

        function initPlantCharts() {
            // 植物环境参数图表
            plantEnvironmentChart = new Chart(
                document.getElementById('plant-environment-chart'),
                {
                    type: 'line',
                    data: {
                        labels: plantData.timeLabels,
                        datasets: [
                            {
                                label: '温度 (°C)',
                                data: plantData.plants[0].temperature.history,
                                borderColor: '#165DFF',
                                backgroundColor: 'rgba(22, 93, 255, 0.1)',
                                tension: 0.3,
                                fill: false
                            },
                            {
                                label: '湿度 (%)',
                                data: plantData.plants[0].humidity.history,
                                borderColor: '#3B82F6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.3,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                min: 0,
                                max: 100
                            }
                        }
                    }
                }
            );

            // 植物土壤湿度图表
            plantSoilChart = new Chart(
                document.getElementById('plant-soil-chart'),
                {
                    type: 'line',
                    data: {
                        labels: plantData.timeLabels,
                        datasets: [
                            {
                                label: '土壤湿度 (%)',
                                data: plantData.plants[0].soilMoisture.history,
                                borderColor: '#F59E0B',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                min: 0,
                                max: 100
                            }
                        }
                    }
                }
            );
        }

        // 初始化整体趋势图表
        function initOverallTrendCharts() {
            // 整体趋势图表
            overallTrendChart = new Chart(
                document.getElementById('overall-trend-chart'),
                {
                    type: 'line',
                    data: {
                        labels: plantData.timeLabels,
                        datasets: [
                            {
                                label: '平均温度 (°C)',
                                data: Array(24).fill(0),
                                borderColor: '#FF6B6B',
                                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                tension: 0.3,
                                fill: false
                            },
                            {
                                label: '平均湿度 (%)',
                                data: Array(24).fill(0),
                                borderColor: '#4D96FF',
                                backgroundColor: 'rgba(77, 150, 255, 0.1)',
                                tension: 0.3,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                min: 0,
                                max: 100
                            }
                        }
                    }
                }
            );

            // 整体土壤湿度图表
            overallSoilChart = new Chart(
                document.getElementById('overall-soil-chart'),
                {
                    type: 'line',
                    data: {
                        labels: plantData.timeLabels,
                        datasets: [
                            {
                                label: '平均土壤湿度 (%)',
                                data: Array(24).fill(0),
                                borderColor: '#6BCB77',
                                backgroundColor: 'rgba(107, 203, 119, 0.1)',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                min: 0,
                                max: 100
                            }
                        }
                    }
                }
            );
        }

        // 更新整体趋势图表
        function updateOverallTrendCharts() {
            // 计算所有植物的平均值
            const tempHistory = Array(24).fill(0);
            const humHistory = Array(24).fill(0);
            const soilHistory = Array(24).fill(0);

            plantData.plants.forEach(plant => {
                for (let i = 0; i < 24; i++) {
                    tempHistory[i] += plant.temperature.history[i] || 0;
                    humHistory[i] += plant.humidity.history[i] || 0;
                    soilHistory[i] += plant.soilMoisture.history[i] || 0;
                }
            });

            // 计算平均值
            const plantCount = plantData.plants.length;
            for (let i = 0; i < 24; i++) {
                tempHistory[i] = tempHistory[i] / plantCount;
                humHistory[i] = humHistory[i] / plantCount;
                soilHistory[i] = soilHistory[i] / plantCount;
            }

            // 更新整体趋势图表
            overallTrendChart.data.datasets[0].data = tempHistory;
            overallTrendChart.data.datasets[1].data = humHistory;
            overallTrendChart.update();

            // 更新整体土壤湿度图表
            overallSoilChart.data.datasets[0].data = soilHistory;
            overallSoilChart.update();

            // 更新统计信息
            updateOverallStats(tempHistory, humHistory, soilHistory);
        }

        // 更新整体统计信息
        function updateOverallStats(tempHistory, humHistory, soilHistory) {
            // 温度统计
            const tempAvg = calculateAverage(tempHistory);
            const tempMax = Math.max(...tempHistory);
            const tempMin = Math.min(...tempHistory);
            const tempVar = calculateVariance(tempHistory);

            document.getElementById('overall-temp-avg').textContent = tempAvg.toFixed(1) + '°C';
            document.getElementById('overall-temp-max').textContent = tempMax.toFixed(1) + '°C';
            document.getElementById('overall-temp-min').textContent = tempMin.toFixed(1) + '°C';
            document.getElementById('overall-temp-var').textContent = tempVar.toFixed(2) + '°C';

            // 湿度统计
            const humAvg = calculateAverage(humHistory);
            const humMax = Math.max(...humHistory);
            const humMin = Math.min(...humHistory);
            const humVar = calculateVariance(humHistory);

            document.getElementById('overall-humidity-avg').textContent = humAvg.toFixed(1) + '%';
            document.getElementById('overall-humidity-max').textContent = humMax.toFixed(1) + '%';
            document.getElementById('overall-humidity-min').textContent = humMin.toFixed(1) + '%';
            document.getElementById('overall-humidity-var').textContent = humVar.toFixed(2) + '%';

            // 土壤湿度统计
            const soilAvg = calculateAverage(soilHistory);
            const soilMax = Math.max(...soilHistory);
            const soilMin = Math.min(...soilHistory);
            const soilVar = calculateVariance(soilHistory);

            document.getElementById('overall-soil-avg').textContent = soilAvg.toFixed(1) + '%';
            document.getElementById('overall-soil-max').textContent = soilMax.toFixed(1) + '%';
            document.getElementById('overall-soil-min').textContent = soilMin.toFixed(1) + '%';
            document.getElementById('overall-soil-var').textContent = soilVar.toFixed(2) + '%';
        }

        // 更新植物图表
        function updatePlantCharts() {
            const selectedPlantId = document.getElementById('plant-select').value;
            const selectedPlant = plantData.plants.find(p => p.id === selectedPlantId);

            if (selectedPlant) {
                // 更新环境参数图表
                plantEnvironmentChart.data.datasets[0].data = selectedPlant.temperature.history;
                plantEnvironmentChart.data.datasets[1].data = selectedPlant.humidity.history;
                plantEnvironmentChart.update();

                // 更新土壤湿度图表
                plantSoilChart.data.datasets[0].data = selectedPlant.soilMoisture.history;
                plantSoilChart.update();

                // 更新当前植物数据显示
                document.getElementById('current-plant-temp').textContent = `${selectedPlant.temperature.current.toFixed(1)}°C`;
                document.getElementById('current-plant-humidity').textContent = `${selectedPlant.humidity.current.toFixed(1)}%`;
                document.getElementById('current-plant-soil').textContent = `${selectedPlant.soilMoisture.current.toFixed(1)}%`;

                // 更新状态标签
                updateStatusBadge('temp', selectedPlant.temperature.current, selectedPlant.temperature.thresholds);
                updateStatusBadge('humidity', selectedPlant.humidity.current, selectedPlant.humidity.thresholds);
                updateStatusBadge('soil', selectedPlant.soilMoisture.current, selectedPlant.soilMoisture.thresholds);

                // 更新1小时平均值
                document.getElementById('temp-1h-avg').textContent = `${calculateAverage(selectedPlant.temperature.history.slice(-4)).toFixed(1)}°C`;
                document.getElementById('humidity-1h-avg').textContent = `${calculateAverage(selectedPlant.humidity.history.slice(-4)).toFixed(1)}%`;
                document.getElementById('soil-1h-avg').textContent = `${calculateAverage(selectedPlant.soilMoisture.history.slice(-4)).toFixed(1)}%`;

                // 更新最大值和最小值
                document.getElementById('temp-max').textContent = `${Math.max(...selectedPlant.temperature.history).toFixed(1)}°C`;
                document.getElementById('humidity-max').textContent = `${Math.max(...selectedPlant.humidity.history).toFixed(1)}%`;
                document.getElementById('soil-max').textContent = `${Math.max(...selectedPlant.soilMoisture.history).toFixed(1)}%`;

                document.getElementById('temp-min').textContent = `${Math.min(...selectedPlant.temperature.history).toFixed(1)}°C`;
                document.getElementById('humidity-min').textContent = `${Math.min(...selectedPlant.humidity.history).toFixed(1)}%`;
                document.getElementById('soil-min').textContent = `${Math.min(...selectedPlant.soilMoisture.history).toFixed(1)}%`;

                // 更新方差
                document.getElementById('temp-variance').textContent = `${calculateVariance(selectedPlant.temperature.history).toFixed(2)}°C`;
                document.getElementById('humidity-variance').textContent = `${calculateVariance(selectedPlant.humidity.history).toFixed(2)}%`;
                document.getElementById('soil-variance').textContent = `${calculateVariance(selectedPlant.soilMoisture.history).toFixed(2)}%`;
            }
        }

        // 计算平均值
        function calculateAverage(arr) {
            return arr.reduce((sum, value) => sum + value, 0) / arr.length;
        }

        // 计算方差
        function calculateVariance(arr) {
            const mean = calculateAverage(arr);
            return calculateAverage(arr.map(x => Math.pow(x - mean, 2)));
        }

        // 更新状态徽章
        function updateStatusBadge(type, value, thresholds) {
            const statusElement = document.getElementById(`${type}-status`);
            const isNormal = value >= thresholds.min && value <= thresholds.max;

            if (isNormal) {
                statusElement.className = 'ml-2 status-badge normal';
                statusElement.textContent = 'Normal';
            } else if (value < thresholds.min) {
                statusElement.className = 'ml-2 status-badge warning';
                statusElement.textContent = 'Low';
            } else {
                statusElement.className = 'ml-2 status-badge warning';
                statusElement.textContent = 'High';
            }
        }

        // 更新仪表盘数据
        function updateDashboard() {
            // 计算平均温度
            const avgTemp = Math.round(plantData.plants.reduce((sum, plant) => sum + plant.temperature.current, 0) / plantData.plants.length * 10) / 10;
            document.getElementById('avg-temp').textContent = `${avgTemp}°C`;
            document.getElementById('temp-progress').style.width = `${Math.min(100, Math.max(0, (avgTemp - 18) * 10))}%`;

            // 计算平均湿度
            const avgHumidity = Math.round(plantData.plants.reduce((sum, plant) => sum + plant.humidity.current, 0) / plantData.plants.length);
            document.getElementById('avg-humidity').textContent = `${avgHumidity}%`;
            document.getElementById('humidity-progress').style.width = `${Math.min(100, Math.max(0, (avgHumidity - 40) * 2))}%`;

            // 计算平均土壤湿度
            const avgSoil = Math.round(plantData.plants.reduce((sum, plant) => sum + plant.soilMoisture.current, 0) / plantData.plants.length);
            document.getElementById('avg-soil').textContent = `${avgSoil}%`;
            document.getElementById('soil-progress').style.width = `${Math.min(100, Math.max(0, (avgSoil - 30) * 2))}%`;

            // 计算警报数量
            const alertCount = plantData.plants.reduce((count, plant) => count + plant.alerts.length, 0);
            document.getElementById('alert-count').textContent = alertCount;

            // 更新历史表格
            updateHistoryTable();
        }

        // 更新历史记录表格
        function updateHistoryTable() {
            const historyTable = document.getElementById('history-table');
            historyTable.innerHTML = '';

            // 生成过去24小时的时间戳
            const now = new Date();
            const times = Array.from({length: 24}, (_, i) => {
                const time = new Date(now.getTime() - i * 60 * 60 * 1000);
                return `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
            }).reverse();

            // 生成表格行
            for (let i = 0; i < 24; i++) {
                const row = document.createElement('tr');
                row.className = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                // 时间列
                const timeCell = document.createElement('td');
                timeCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                timeCell.textContent = times[i];
                row.appendChild(timeCell);

                // 计算平均温度
                const tempAvg = calculateAverage(plantData.plants.map(plant => plant.temperature.history[i] || 0));
                const tempCell = document.createElement('td');
                tempCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                tempCell.textContent = `${tempAvg.toFixed(1)}°C`;
                row.appendChild(tempCell);

                // 计算平均湿度
                const humAvg = calculateAverage(plantData.plants.map(plant => plant.humidity.history[i] || 0));
                const humidityCell = document.createElement('td');
                humidityCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                humidityCell.textContent = `${humAvg.toFixed(1)}%`;
                row.appendChild(humidityCell);

                // 计算平均土壤湿度
                const soilAvg = calculateAverage(plantData.plants.map(plant => plant.soilMoisture.history[i] || 0));
                const soilCell = document.createElement('td');
                soilCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                soilCell.textContent = `${soilAvg.toFixed(1)}%`;
                row.appendChild(soilCell);

                // 警报列
                const alertCell = document.createElement('td');
                alertCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                const totalAlerts = plantData.plants.reduce((count, plant) => {
                    // 检查该时间点是否有警报
                    const hasAlert = plant.alerts.some(alert => {
                        const alertTime = new Date(alert.time);
                        return alertTime.getHours() === parseInt(times[i].split(':')[0]);
                    });
                    return count + (hasAlert ? 1 : 0);
                }, 0);
                alertCell.textContent = totalAlerts;
                row.appendChild(alertCell);

                historyTable.appendChild(row);
            }
        }

        // 为Refresh Data按钮添加点击事件监听器
        const refreshButton = document.getElementById('refresh-data-btn');
        refreshButton.addEventListener('click', () => {
            DataReceiver.refreshData();
        });

        // 为Custom Thresholds按钮添加点击事件监听器
        const customizeThresholdButton = document.getElementById('customize-threshold');
        const thresholdModal = document.getElementById('threshold-modal');
        const closeModalButton = document.getElementById('close-modal');
        const saveThresholdsButton = document.getElementById('save-thresholds');

        customizeThresholdButton.addEventListener('click', () => {
            // 填充当前阈值
            const selectedPlantId = document.getElementById('plant-select').value;
            const selectedPlant = plantData.plants.find(p => p.id === selectedPlantId);

            if (selectedPlant) {
                document.getElementById('temp-min-threshold').value = selectedPlant.temperature.thresholds.min;
                document.getElementById('temp-max-threshold').value = selectedPlant.temperature.thresholds.max;
                document.getElementById('humidity-min-threshold').value = selectedPlant.humidity.thresholds.min;
                document.getElementById('humidity-max-threshold').value = selectedPlant.humidity.thresholds.max;
                document.getElementById('soil-min-threshold').value = selectedPlant.soilMoisture.thresholds.min;
                document.getElementById('soil-max-threshold').value = selectedPlant.soilMoisture.thresholds.max;
            }

            thresholdModal.classList.remove('hidden');
        });

        closeModalButton.addEventListener('click', () => {
            thresholdModal.classList.add('hidden');
        });

        // 为Save Settings按钮添加点击事件监听器
        saveThresholdsButton.addEventListener('click', () => {
            // 获取用户输入的阈值
            const tempMin = parseFloat(document.getElementById('temp-min-threshold').value);
            const tempMax = parseFloat(document.getElementById('temp-max-threshold').value);
            const humidityMin = parseFloat(document.getElementById('humidity-min-threshold').value);
            const humidityMax = parseFloat(document.getElementById('humidity-max-threshold').value);
            const soilMin = parseFloat(document.getElementById('soil-min-threshold').value);
            const soilMax = parseFloat(document.getElementById('soil-max-threshold').value);

            // 验证输入
            if (tempMin >= tempMax || humidityMin >= humidityMax || soilMin >= soilMax) {
                alert('Minimum threshold must be less than maximum threshold!');
                return;
            }

            // 更新当前选中植物的阈值
            const selectedPlantId = document.getElementById('plant-select').value;
            const selectedPlant = plantData.plants.find(p => p.id === selectedPlantId);

            if (selectedPlant) {
                selectedPlant.temperature.thresholds.min = tempMin;
                selectedPlant.temperature.thresholds.max = tempMax;
                selectedPlant.humidity.thresholds.min = humidityMin;
                selectedPlant.humidity.thresholds.max = humidityMax;
                selectedPlant.soilMoisture.thresholds.min = soilMin;
                selectedPlant.soilMoisture.thresholds.max = soilMax;

                // 更新状态徽章
                updateStatusBadge('temp', selectedPlant.temperature.current, selectedPlant.temperature.thresholds);
                updateStatusBadge('humidity', selectedPlant.humidity.current, selectedPlant.humidity.thresholds);
                updateStatusBadge('soil', selectedPlant.soilMoisture.current, selectedPlant.soilMoisture.thresholds);

                // 关闭模态框
                thresholdModal.classList.add('hidden');

                // 显示保存成功提示
                const notification = document.createElement('div');
                notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                notification.textContent = 'Thresholds saved successfully!';
                document.body.appendChild(notification);

                // 3秒后自动消失
                setTimeout(() => {
                    notification.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 500);
                }, 3000);
            }
        });

        // 为植物选择下拉菜单添加事件监听器
        const plantSelect = document.getElementById('plant-select');
        plantSelect.addEventListener('change', updatePlantCharts);

        // 初始化数据接收
        DataReceiver.init();

        // 初始化图表
        initPlantCharts();
        initOverallTrendCharts();

        // 初始更新仪表盘
        updateDashboard();
        updatePlantCharts();
        updateOverallTrendCharts();
    </script>
</body>
</html>
